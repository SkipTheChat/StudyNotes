# ğŸ„ ä¸€ 

## 1.1 å‚æ•°ç±»å‹ 

-XXå‚æ•°ä¹Ÿæ˜¯éæ ‡å‡†å‚æ•°ï¼Œä¸»è¦ç”¨äºjvmçš„è°ƒä¼˜å’Œdebugæ“ä½œã€‚
-XXå‚æ•°çš„ä½¿ç”¨æœ‰2ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯booleanç±»å‹ï¼Œä¸€ç§æ˜¯ébooleanç±»å‹ï¼š

booleanç±»å‹

æ ¼å¼ï¼š-XX:[+-]<name> è¡¨ç¤ºå¯ç”¨æˆ–ç¦ç”¨<name>å±æ€§
å¦‚ï¼š-XX:+DisableExplicitGC è¡¨ç¤ºç¦ç”¨æ‰‹åŠ¨è°ƒç”¨gcæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨System.gc()æ— æ•ˆ



ébooleanç±»å‹
æ ¼å¼ï¼š-XX:<name>=<value> è¡¨ç¤º<name>å±æ€§çš„å€¼ä¸º<value>
å¦‚ï¼š-XX:NewRatio=1 è¡¨ç¤ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¯”å€¼



## 1.2 -Xmsä¸-Xmxå‚æ•°

-Xmsä¸-Xmxåˆ†åˆ«æ˜¯è®¾ç½®jvmçš„å †å†…å­˜çš„åˆå§‹å¤§å°å’Œæœ€å¤§å¤§å°ã€‚
-Xmx2048mï¼šç­‰ä»·äº-XX:MaxHeapSizeï¼Œè®¾ç½®JVMæœ€å¤§å †å†…å­˜ä¸º2048Mã€‚
-Xms512mï¼šç­‰ä»·äº-XX:InitialHeapSizeï¼Œè®¾ç½®JVMåˆå§‹å †å†…å­˜ä¸º512Mã€‚
ç¤ºä¾‹ï¼š

```shell
[root@node01 test]# java -Xms512m -Xmx2048m TestJVM
```



## 1.3 æŸ¥çœ‹jvmçš„è¿è¡Œå‚æ•°

### 1.3.1 è¿è¡Œjavaå‘½ä»¤æ—¶æ‰“å°å‡ºè¿è¡Œå‚æ•°

è¿è¡Œjavaå‘½ä»¤æ—¶æ‰“å°å‚æ•°ï¼Œéœ€è¦æ·»åŠ -XX:+PrintFlagsFinalå‚æ•°å³å¯

```shell
[root@node01 test]# java -XX:+PrintFlagsFinal -version
[Global flags]
uintx AdaptiveSizeDecrementScaleFactor = 4
{product}
â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦ç•¥â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦
bool VMThreadHintNoPreempt = false
{product}
intx VMThreadPriority = -1
{product}

```

> å‚æ•°æœ‰booleanç±»å‹å’Œæ•°å­—ç±»å‹ï¼Œå€¼çš„æ“ä½œç¬¦æ˜¯=æˆ–:=ï¼Œåˆ†åˆ«ä»£è¡¨é»˜è®¤å€¼å’Œè¢«ä¿®æ”¹çš„å€¼ã€‚



### 1.3.2 æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„javaè¿›ç¨‹çš„å‚æ•°

> jinfo -flags <è¿›ç¨‹id>

> è¿›ç¨‹idå¯ä»¥é€šè¿‡ps-ef | grep  tomcatè·å–ä¹Ÿå¯ä»¥ç”¨jps -lè·å–

```shell
#æŸ¥çœ‹æ‰€æœ‰çš„å‚æ•°ï¼Œç”¨æ³•ï¼šjinfo -flags <è¿›ç¨‹id>
#é€šè¿‡jps æˆ–è€… jps -l æŸ¥çœ‹javaè¿›ç¨‹
[root@node01 bin]# jps
6346 Jps
6219 Bootstrap
[root@node01 bin]# jps -l
6358 sun.tools.jps.Jps
6219 org.apache.catalina.startup.Bootstrap
[root@node01 bin]#
[root@node01 bin]# jinfo -flags 6219
...
Non-default VM flags: -XX:CICompilerCount=2 -XX:InitialHeapSize=31457280 -
XX:MaxHeapSize=488636416 -XX:MaxNewSize=162529280 -XX:MinHeapDeltaBytes=524288 -
XX:NewSize=10485760 -XX:OldSize=20971520 -XX:+UseCompressedClassPointers -
XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStamps -XX:+UseParallelGC
...
```



```shell
#æŸ¥çœ‹æŸä¸€å‚æ•°çš„å€¼ï¼Œç”¨æ³•ï¼šjinfo -flag <å‚æ•°å> <è¿›ç¨‹id>
[root@node01 bin]# jinfo -flag MaxHeapSize 6219
-XX:MaxHeapSize=488636416
```



## 1.4 é€šè¿‡jstatå‘½ä»¤è¿›è¡ŒæŸ¥çœ‹å †å†…å­˜ä½¿ç”¨æƒ…å†µ

jstatå‘½ä»¤å¯ä»¥æŸ¥çœ‹å †å†…å­˜å„éƒ¨åˆ†çš„ä½¿ç”¨é‡ï¼Œä»¥åŠåŠ è½½ç±»çš„æ•°é‡ã€‚

### 1.4.1 æŸ¥çœ‹classåŠ è½½ç»Ÿè®¡

```shell
[root@node01 ~]# jps
7080 Jps
6219 Bootstrap

[root@node01 ~]# jstat -class 6219
Loaded Bytes Unloaded Bytes Time
3273   7122.3    0     0.0  3.98
```

è¯´æ˜ï¼š
Loadedï¼šåŠ è½½classçš„æ•°é‡
Bytesï¼šæ‰€å ç”¨ç©ºé—´å¤§å°
Unloadedï¼šæœªåŠ è½½æ•°é‡
Bytesï¼šæœªåŠ è½½å ç”¨ç©ºé—´
Timeï¼šæ—¶é—´



### 1.4.2 æŸ¥çœ‹ç¼–è¯‘ç»Ÿè®¡

```shell
[root@node01 ~]# jstat -compiler 6219
Compiled Failed Invalid Time FailedType FailedMethod
2376       1      0     8.04     1     org/apache/tomcat/util/IntrospectionUtils
setProperty
```

è¯´æ˜ï¼š
Compiledï¼šç¼–è¯‘æ•°é‡ã€‚
Failedï¼šå¤±è´¥æ•°é‡
Invalidï¼šä¸å¯ç”¨æ•°é‡
Timeï¼šæ—¶é—´
FailedTypeï¼šå¤±è´¥ç±»å‹
FailedMethodï¼šå¤±è´¥çš„æ–¹æ³•



### 1.4.3 åƒåœ¾å›æ”¶ç»Ÿè®¡

```shell
[root@node01 ~]# jstat -gc 6219
S0C S1C S0U S1U EC EU OC OU MC MU CCSC
CCSU YGC YGCT FGC FGCT GCT
9216.0 8704.0 0.0 6127.3 62976.0 3560.4 33792.0 20434.9 23808.0 23196.1
2560.0 2361.6 7 1.078 1 0.244 1.323
#ä¹Ÿå¯ä»¥æŒ‡å®šæ‰“å°çš„é—´éš”å’Œæ¬¡æ•°ï¼Œæ¯1ç§’ä¸­æ‰“å°ä¸€æ¬¡ï¼Œå…±æ‰“å°5æ¬¡

[root@node01 ~]# jstat -gc 6219 1000 5
S0C     S1C   S0U S1U     EC      EU     OC       OU     MC      MU 
CCSCCCSU YGC YGCT FGC    FGCT     GCT
9216.0 8704.0 0.0 6127.3 62976.0 3917.3 33792.0 20434.9 23808.0 23196.1
2560.0 2361.6 7 1.078 1 0.244 1.323
9216.0 8704.0 0.0 6127.3 62976.0 3917.3 33792.0 20434.9 23808.0 23196.1
2560.0 2361.6 7 1.078 1 0.244 1.323
9216.0 8704.0 0.0 6127.3 62976.0 3917.3 33792.0 20434.9 23808.0 23196.1
2560.0 2361.6 7 1.078 1 0.244 1.323
9216.0 8704.0 0.0 6127.3 62976.0 3917.3 33792.0 20434.9 23808.0 23196.1
2560.0 2361.6 7 1.078 1 0.244 1.323
9216.0 8704.0 0.0 6127.3 62976.0 3917.3 33792.0 20434.9 23808.0 23196.1
2560.0 2361.6 7 1.078 1 0.244 1.323
```

è¯´æ˜ï¼š
S0Cï¼šç¬¬ä¸€ä¸ªSurvivoråŒºçš„å¤§å°ï¼ˆKBï¼‰
S1Cï¼šç¬¬äºŒä¸ªSurvivoråŒºçš„å¤§å°ï¼ˆKBï¼‰
S0Uï¼šç¬¬ä¸€ä¸ªSurvivoråŒºçš„ä½¿ç”¨å¤§å°ï¼ˆKBï¼‰
S1Uï¼šç¬¬äºŒä¸ªSurvivoråŒºçš„ä½¿ç”¨å¤§å°ï¼ˆKBï¼‰
ECï¼šEdenåŒºçš„å¤§å°ï¼ˆKBï¼‰
EUï¼šEdenåŒºçš„ä½¿ç”¨å¤§å°ï¼ˆKBï¼‰
OCï¼šOldåŒºå¤§å°ï¼ˆKBï¼‰
OUï¼šOldä½¿ç”¨å¤§å°ï¼ˆKBï¼‰
MCï¼šæ–¹æ³•åŒºå¤§å°ï¼ˆKBï¼‰
MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å°ï¼ˆKBï¼‰
CCSCï¼šå‹ç¼©ç±»ç©ºé—´å¤§å°ï¼ˆKBï¼‰
CCSUï¼šå‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å°ï¼ˆKBï¼‰
YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•°
FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´
GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´



## 1.5  jmapçš„ä½¿ç”¨ä»¥åŠå†…å­˜æº¢å‡ºåˆ†æ

å‰é¢é€šè¿‡jstatå¯ä»¥å¯¹jvmå †çš„å†…å­˜è¿›è¡Œç»Ÿè®¡åˆ†æï¼Œè€Œjmapå¯ä»¥è·å–åˆ°æ›´åŠ è¯¦ç»†çš„å†…å®¹ï¼Œå¦‚ï¼šå†…å­˜ä½¿ç”¨æƒ…å†µçš„æ±‡æ€»ã€
å¯¹å†…å­˜æº¢å‡ºçš„å®šä½ä¸åˆ†æã€‚



### 1.5.1 æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ

```shell
[root@node01 ~]# jmap -heap 6219
Attaching to process ID 6219, please wait...
Debugger attached successfully.
Server compiler detected.
JVM version is 25.141-b15
using thread-local object allocation.
Parallel GC with 2 thread(s)
Heap Configuration: #å †å†…å­˜é…ç½®ä¿¡æ¯
MinHeapFreeRatio 	    = 0
MaxHeapFreeRatio	    = 100
MaxHeapSize 		    = 488636416 (466.0MB)
NewSize 			    = 10485760 (10.0MB)
MaxNewSize 			    = 162529280 (155.0MB)
OldSize 			    = 20971520 (20.0MB)
NewRatio 			    = 2
SurvivorRatio 			= 8
MetaspaceSize			= 21807104 (20.796875MB)
CompressedClassSpaceSize = 1073741824 (1024.0MB)
MaxMetaspaceSize		= 17592186044415 MB
G1HeapRegionSize		= 0 (0.0MB)

Heap Usage: # å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µ
PS Young Generation #å¹´è½»ä»£
Eden Space:
capacity = 123731968 (118.0MB)
used = 1384736 (1.320587158203125MB)
free = 122347232 (116.67941284179688MB)
1.1191416594941737% used
From Space:
capacity = 9437184 (9.0MB)
used = 0 (0.0MB)
free = 9437184 (9.0MB)
0.0% used
To Space:
capacity = 9437184 (9.0MB)
used = 0 (0.0MB)
free = 9437184 (9.0MB)
0.0% used
PS Old Generation #å¹´è€ä»£
capacity = 28311552 (27.0MB)
used = 13698672 (13.064071655273438MB)
free = 14612880 (13.935928344726562MB)
48.38545057508681% used
13648 interned Strings occupying 1866368 bytes.
```



### 1.5.2 æŸ¥çœ‹å†…å­˜ä¸­å¯¹è±¡æ•°é‡åŠå¤§å°

> æŸ¥çœ‹æ‰€æœ‰å¯¹è±¡ï¼ŒåŒ…æ‹¬æ´»è·ƒä»¥åŠéæ´»è·ƒçš„
>
> jmap -histo <pid> | more



> æŸ¥çœ‹æ´»è·ƒå¯¹è±¡
>
> jmap -histo:live <pid> | more

```shell
[root@node01 ~]# jmap -histo:live 6219 | more
num 	#instances 	#bytes 	class name
----------------------------------------------
1: 		37437 		7914608 	[C
2: 		34916 		837984 		java.lang.String
3: 		884 		654848 		[B
4: 		17188 		550016 		java.util.HashMap$Node
5: 		3674 		424968 		java.lang.Class
6: 		6322 		395512 		[Ljava.lang.Object;
7: 		3738 		328944 		java.lang.reflect.Method
8: 		1028 		208048 		[Ljava.util.HashMap$Node;
9: 		2247 		144264 		[I
10: 	4305 		137760 		java.util.concurrent.ConcurrentHashMap$Node
11: 	1270 		109080 		[Ljava.lang.String;
12: 	64 			84128 		[Ljava.util.concurrent.ConcurrentHashMap$Node;
13: 	1714 		82272 		java.util.HashMap
14: 	3285 		70072 		[Ljava.lang.Class;
15: 	2888 		69312 		java.util.ArrayList
16: 	3983 		63728 		java.lang.Object
17: 	1271 		61008 		org.apache.tomcat.util.digester.CallMethodRule
18: 	1518 		60720 		java.util.LinkedHashMap$Entry
19: 	1671 		53472 		com.sun.org.apache.xerces.internal.xni.QName
20: 	88 			50880 		[Ljava.util.WeakHashMap$Entry;
21: 	618 		49440 		java.lang.reflect.Constructor
22: 	1545 		49440 		java.util.Hashtable$Entry
23: 	1027 		41080 		java.util.TreeMap$Entry
24: 	846 		40608 		org.apache.tomcat.util.modeler.AttributeInfo
25: 	142 		38032 		[S
26: 	946 		37840 		java.lang.ref.SoftReference
27: 	226 		36816 		[[C
ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚

```



å¯¹è±¡è¯´æ˜

B byte
C char
D double
F float
I int
J long
Z boolean

[ æ•°ç»„ï¼Œå¦‚[Iè¡¨ç¤ºint[]
[L+ç±»å å…¶ä»–å¯¹è±¡



### 1.5.3 å°†å†…å­˜ä½¿ç”¨æƒ…å†µdumpåˆ°æ–‡ä»¶ä¸­

æœ‰äº›æ—¶å€™æˆ‘ä»¬éœ€è¦å°†jvmå½“å‰å†…å­˜ä¸­çš„æƒ…å†µdumpåˆ°æ–‡ä»¶ä¸­ï¼Œç„¶åå¯¹å®ƒè¿›è¡Œåˆ†æï¼Œjmapä¹Ÿæ˜¯æ”¯æŒdumpåˆ°æ–‡ä»¶ä¸­
çš„ã€‚

```shell
#ç”¨æ³•ï¼š
jmap -dump:format=b,file=dumpFileName <pid>
#ç¤ºä¾‹
jmap -dump:format=b,file=/tmp/dump.dat 6219
```

å¯ä»¥çœ‹åˆ°å·²ç»åœ¨/tmpä¸‹ç”Ÿæˆäº†dump.datçš„æ–‡ä»¶ã€‚
![](./assets/13.1.jpg)



## 1.6 åˆ†ædumpæ–‡ä»¶

### 1.6.1 é€šè¿‡jhatå¯¹dumpæ–‡ä»¶è¿›è¡Œåˆ†æ

åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†jvmçš„å†…å­˜dumpåˆ°æ–‡ä»¶ä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶çš„æ–‡ä»¶ï¼Œä¸æ–¹ä¾¿æŸ¥çœ‹ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å€Ÿ
åŠ©äºjhatå·¥å…·è¿›è¡ŒæŸ¥çœ‹ã€‚

> ç”¨æ³•ï¼šjhat -port <port> <file>

```shell
#ç¤ºä¾‹ï¼š
[root@node01 tmp]# jhat -port 9999 /tmp/dump.dat
Reading from /tmp/dump.dat...
Dump file created Mon Sep 10 01:04:21 CST 2018
Snapshot read, resolving...
Resolving 204094 objects...
Chasing references, expect 40 dots........................................
Eliminating duplicate references........................................
Snapshot resolved.
Started HTTP server on port 9999
Server is ready.
```

æ‰“å¼€æµè§ˆå™¨è®¿é—®9999ç«¯å£



![](./assets/13.2.jpg)

åœ¨æœ€åé¢æœ‰OQLæŸ¥è¯¢åŠŸèƒ½ã€‚

![](./assets/13.3.jpg)

![](./assets/13.4.jpg)





### 1.6.2 é€šè¿‡MATå·¥å…·å¯¹dumpæ–‡ä»¶è¿›è¡Œåˆ†æå®šä½OOM

MAT(Memory Analyzer Tool)ï¼Œä¸€ä¸ªåŸºäºEclipseçš„å†…å­˜åˆ†æå·¥å…·ï¼Œæ˜¯ä¸€ä¸ªå¿«é€Ÿã€åŠŸèƒ½ä¸°å¯Œçš„JAVA heapåˆ†æå·¥å…·ï¼Œ
å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æŸ¥æ‰¾å†…å­˜æ³„æ¼å’Œå‡å°‘å†…å­˜æ¶ˆè€—ã€‚ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·ä»ä¼—å¤šçš„å¯¹è±¡ä¸­è¿›è¡Œåˆ†æï¼Œå¿«é€Ÿçš„è®¡ç®—å‡ºåœ¨å†…å­˜
ä¸­å¯¹è±¡çš„å ç”¨å¤§å°ï¼Œçœ‹çœ‹æ˜¯è°é˜»æ­¢äº†åƒåœ¾æ”¶é›†å™¨çš„å›æ”¶å·¥ä½œï¼Œå¹¶å¯ä»¥é€šè¿‡æŠ¥è¡¨ç›´è§‚çš„æŸ¥çœ‹åˆ°å¯èƒ½é€ æˆè¿™ç§ç»“æœçš„å¯¹
è±¡ã€‚



**1.ç¼–å†™ä»£ç ï¼Œå‘Listé›†åˆä¸­æ·»åŠ 100ä¸‡ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²ç”±1000ä¸ªUUIDç»„æˆï¼Œæ¨¡æ‹Ÿå†…å­˜æº¢å‡ºã€‚**

>  å¯ä»¥åœ¨ideaçš„configurationsé‡Œé¢å®šä¹‰VMå‚æ•°æ–¹ä¾¿å¿«é€Ÿæº¢å‡º

![](./assets/13.5.jpg)

```shell
#å‚æ•°å¦‚ä¸‹ï¼š
#HeapDumpOnOutOfMemoryErrorï¼šå‘ç”Ÿå †å†…å­˜æº¢å‡ºæ—¶dumpå †å†…å­˜
-Xms8m -Xmx8m -XX:+HeapDumpOnOutOfMemoryError
```



è¿è¡ŒæŠ¥é”™å¦‚ä¸‹ï¼šå¯ä»¥çœ‹åˆ°dumpäº†ä¸€ä¸ªæ–‡ä»¶

```shell
java.lang.OutOfMemoryError: Java heap space
Dumping heap to java_pid5348.hprof ... # dumpåˆ°äº†java_pid5348.hprofæ–‡ä»¶ä¸­
Heap dump file created [8137186 bytes in 0.032 secs]
Exception in thread "main" java.lang.OutOfMemoryError: Java heap space
at java.util.Arrays.copyOf(Arrays.java:3332)
at
java.lang.AbstractStringBuilder.ensureCapacityInternal(AbstractStringBuilder.java:124)
at java.lang.AbstractStringBuilder.append(AbstractStringBuilder.java:448)
at java.lang.StringBuilder.append(StringBuilder.java:136)
at cn.itcast.jvm.TestJvmOutOfMemory.main(TestJvmOutOfMemory.java:14)
Process finished with exit code 1
```



**2.å°†æ–‡ä»¶å¯¼å…¥åˆ°MATå·¥å…·ä¸­è¿›è¡Œåˆ†æ**

![](./assets/13.6.jpg)

å¯ä»¥çœ‹åˆ°ï¼Œæœ‰91.03%çš„å†…å­˜ç”±Object[]æ•°ç»„å æœ‰ï¼Œæ‰€ä»¥æ¯”è¾ƒå¯ç–‘ã€‚å› ä¸ºliståº•å±‚æ˜¯Objectæ•°ç»„å®ç°çš„ã€‚



æŸ¥çœ‹è¯¦æƒ…ï¼š

![](./assets/13.7.jpg)

å¯ä»¥çœ‹åˆ°é›†åˆä¸­å­˜å‚¨äº†å¤§é‡çš„uuidå­—ç¬¦ä¸²ã€‚





## 1.7 jstackçš„ä½¿ç”¨

æœ‰äº›æ—¶å€™æˆ‘ä»¬éœ€è¦æŸ¥çœ‹ä¸‹jvmä¸­çš„çº¿ç¨‹æ‰§è¡Œæƒ…å†µï¼Œæ¯”å¦‚ï¼Œå‘ç°æœåŠ¡å™¨çš„CPUçš„è´Ÿè½½çªç„¶å¢é«˜äº†ã€å‡ºç°äº†æ­»é”ã€æ­»å¾ª
ç¯ç­‰ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•åˆ†æå‘¢ï¼Ÿ
ç”±äºç¨‹åºæ˜¯æ­£å¸¸è¿è¡Œçš„ï¼Œæ²¡æœ‰ä»»ä½•çš„è¾“å‡ºï¼Œä»æ—¥å¿—æ–¹é¢ä¹Ÿçœ‹ä¸å‡ºä»€ä¹ˆé—®é¢˜ï¼Œæ‰€ä»¥å°±éœ€è¦çœ‹ä¸‹jvmçš„å†…éƒ¨çº¿ç¨‹çš„æ‰§è¡Œ
æƒ…å†µï¼Œç„¶åå†è¿›è¡Œåˆ†ææŸ¥æ‰¾å‡ºåŸå› ã€‚
è¿™ä¸ªæ—¶å€™ï¼Œå°±éœ€è¦å€ŸåŠ©äºjstackå‘½ä»¤äº†ï¼Œjstackçš„ä½œç”¨æ˜¯å°†æ­£åœ¨è¿è¡Œçš„jvmçš„çº¿ç¨‹æƒ…å†µè¿›è¡Œå¿«ç…§ï¼Œå¹¶ä¸”æ‰“å°å‡ºæ¥ï¼š

```shell
#ç”¨æ³•ï¼šjstack <pid>
[root@node01 bin]# jstack 2203
```



### 1.7.1 çº¿ç¨‹çš„çŠ¶æ€

![](./assets/13.8.jpg)



åœ¨Javaä¸­çº¿ç¨‹çš„çŠ¶æ€ä¸€å…±è¢«åˆ†æˆ6ç§ï¼š

* åˆå§‹æ€ï¼ˆNEWï¼‰

  åˆ›å»ºä¸€ä¸ªThreadå¯¹è±¡ï¼Œä½†è¿˜æœªè°ƒç”¨start()å¯åŠ¨çº¿ç¨‹æ—¶ï¼Œçº¿ç¨‹å¤„äºåˆå§‹æ€ã€‚

* è¿è¡Œæ€ï¼ˆRUNNABLEï¼‰ï¼Œåœ¨Javaä¸­ï¼Œè¿è¡Œæ€åŒ…æ‹¬ å°±ç»ªæ€ å’Œ è¿è¡Œæ€ã€‚

  * å°±ç»ªæ€

    è¯¥çŠ¶æ€ä¸‹çš„çº¿ç¨‹å·²ç»è·å¾—æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰èµ„æºï¼Œåªè¦CPUåˆ†é…æ‰§è¡Œæƒå°±èƒ½è¿è¡Œã€‚
    æ‰€æœ‰å°±ç»ªæ€çš„çº¿ç¨‹å­˜æ”¾åœ¨å°±ç»ªé˜Ÿåˆ—ä¸­ã€‚

  * è¿è¡Œæ€

    è·å¾—CPUæ‰§è¡Œæƒï¼Œæ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ã€‚
    ç”±äºä¸€ä¸ªCPUåŒä¸€æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€æ¡çº¿ç¨‹ï¼Œå› æ­¤æ¯ä¸ªCPUæ¯ä¸ªæ—¶åˆ»åªæœ‰ä¸€æ¡è¿è¡Œæ€çš„çº¿ç¨‹ã€‚



* é˜»å¡æ€ï¼ˆBLOCKEDï¼‰
  * å½“ä¸€æ¡æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹è¯·æ±‚æŸä¸€èµ„æºå¤±è´¥æ—¶ï¼Œå°±ä¼šè¿›å…¥é˜»å¡æ€ã€‚
  * è€Œåœ¨Javaä¸­ï¼Œé˜»å¡æ€ä¸“æŒ‡è¯·æ±‚é”å¤±è´¥æ—¶è¿›å…¥çš„çŠ¶æ€ã€‚
  * ç”±ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—å­˜æ”¾æ‰€æœ‰é˜»å¡æ€çš„çº¿ç¨‹ã€‚
  * å¤„äºé˜»å¡æ€çš„çº¿ç¨‹ä¼šä¸æ–­è¯·æ±‚èµ„æºï¼Œä¸€æ—¦è¯·æ±‚æˆåŠŸï¼Œå°±ä¼šè¿›å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œã€‚



* ç­‰å¾…æ€ï¼ˆWAITINGï¼‰
  * å½“å‰çº¿ç¨‹ä¸­è°ƒç”¨waitã€joinã€parkå‡½æ•°æ—¶ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šè¿›å…¥ç­‰å¾…æ€ã€‚
  * ä¹Ÿæœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å­˜æ”¾æ‰€æœ‰ç­‰å¾…æ€çš„çº¿ç¨‹ã€‚
  * çº¿ç¨‹å¤„äºç­‰å¾…æ€è¡¨ç¤ºå®ƒéœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹çš„æŒ‡ç¤ºæ‰èƒ½ç»§ç»­è¿è¡Œã€‚
  * è¿›å…¥ç­‰å¾…æ€çš„çº¿ç¨‹ä¼šé‡Šæ”¾CPUæ‰§è¡Œæƒï¼Œå¹¶é‡Šæ”¾èµ„æºï¼ˆå¦‚ï¼šé”ï¼‰



* è¶…æ—¶ç­‰å¾…æ€ï¼ˆTIMED_WAITINGï¼‰

  å½“è¿è¡Œä¸­çš„çº¿ç¨‹è°ƒç”¨sleep(time)ã€waitã€joinã€parkNanosã€parkUntilæ—¶ï¼Œå°±ä¼šè¿›å…¥è¯¥çŠ¶æ€ï¼›
  å®ƒå’Œç­‰å¾…æ€ä¸€æ ·ï¼Œå¹¶ä¸æ˜¯å› ä¸ºè¯·æ±‚ä¸åˆ°èµ„æºï¼Œè€Œæ˜¯ä¸»åŠ¨è¿›å…¥ï¼Œå¹¶ä¸”è¿›å…¥åéœ€è¦å…¶ä»–çº¿ç¨‹å”¤é†’ï¼›
  è¿›å…¥è¯¥çŠ¶æ€åé‡Šæ”¾CPUæ‰§è¡Œæƒ å’Œ å æœ‰çš„èµ„æºã€‚
  ä¸ç­‰å¾…æ€çš„åŒºåˆ«ï¼šåˆ°äº†è¶…æ—¶æ—¶é—´åè‡ªåŠ¨è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¼€å§‹ç«äº‰é”ã€‚

* ç»ˆæ­¢æ€ï¼ˆTERMINATEDï¼‰

  çº¿ç¨‹æ‰§è¡Œç»“æŸåçš„çŠ¶æ€ã€‚



### 1.7.2 å®æˆ˜ï¼šæ­»é”é—®é¢˜

å¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒå‘ç”Ÿäº†æ­»é”ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°çš„æ˜¯éƒ¨ç½²çš„ç¨‹åºæ²¡æœ‰ä»»ä½•ååº”äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å€ŸåŠ©jstackè¿›è¡Œåˆ†
æï¼Œä¸‹é¢æˆ‘ä»¬å®æˆ˜ä¸‹æŸ¥æ‰¾æ­»é”çš„åŸå› ã€‚

**1.åœ¨linuxä¸Šè¿è¡Œ**

```shell
[root@node01 test]# javac TestDeadLock.java
[root@node01 test]# java TestDeadLock
Thread1 æ‹¿åˆ°äº† obj1 çš„é”ï¼
Thread2 æ‹¿åˆ°äº† obj2 çš„é”ï¼
#è¿™é‡Œå‘ç”Ÿäº†æ­»é”ï¼Œç¨‹åºä¸€ç›´å°†ç­‰å¾…ä¸‹å»
```



**2.ä½¿ç”¨jstackè¿›è¡Œåˆ†æ**

å…ˆä½¿ç”¨jps -læ‰¾åˆ°è¿›ç¨‹id

```shell
[root@node01 ~]# jstack 3256
...
...
Found one Java-level deadlock: #æ‰¾åˆ°æ­»é”
=============================
"Thread-1":
waiting to lock monitor 0x00007f5c080062c8 (object 0x00000000f655dc40, a
java.lang.Object),
which is held by "Thread-0"
"Thread-0":
waiting to lock monitor 0x00007f5c08004e28 (object 0x00000000f655dc50, a
java.lang.Object),
which is held by "Thread-1"
Java stack information for the threads listed above:
===================================================
"Thread-1":  # æ­»é”æ¶‰åŠçº¿ç¨‹å…·ä½“ä¿¡æ¯
at TestDeadLock$Thread2.run(TestDeadLock.java:47)
- waiting to lock <0x00000000f655dc40> (a java.lang.Object)
- locked <0x00000000f655dc50> (a java.lang.Object)
at java.lang.Thread.run(Thread.java:748)
"Thread-0":# æ­»é”æ¶‰åŠçº¿ç¨‹å…·ä½“ä¿¡æ¯
at TestDeadLock$Thread1.run(TestDeadLock.java:27)
- waiting to lock <0x00000000f655dc50> (a java.lang.Object)
- locked <0x00000000f655dc40> (a java.lang.Object)
at java.lang.Thread.run(Thread.java:748)
Found 1 deadlock.
```

å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼š
Thread2è·å–äº† <0x00000000f655dc50> çš„é”ï¼Œç­‰å¾…è·å– <0x00000000f655dc40> è¿™ä¸ªé”
Thread1è·å–äº† <0x00000000f655dc40> çš„é”ï¼Œç­‰å¾…è·å– <0x00000000f655dc50> è¿™ä¸ªé”
ç”±æ­¤å¯è§ï¼Œå‘ç”Ÿäº†æ­»é”ã€‚



### 1.7 VisualVMå·¥å…·çš„ä½¿ç”¨

VisualVMï¼Œèƒ½å¤Ÿç›‘æ§çº¿ç¨‹ï¼Œå†…å­˜æƒ…å†µï¼ŒæŸ¥çœ‹æ–¹æ³•çš„CPUæ—¶é—´å’Œå†…å­˜ä¸­çš„å¯¹ è±¡ï¼Œå·²è¢«GCçš„å¯¹è±¡ï¼Œåå‘æŸ¥çœ‹åˆ†é…çš„å †
æ ˆ(å¦‚100ä¸ªStringå¯¹è±¡åˆ†åˆ«ç”±å“ªå‡ ä¸ªå¯¹è±¡åˆ†é…å‡ºæ¥çš„)ã€‚
VisualVMä½¿ç”¨ç®€å•ï¼Œå‡ ä¹0é…ç½®ï¼ŒåŠŸèƒ½è¿˜æ˜¯æ¯”è¾ƒä¸°å¯Œçš„ï¼Œå‡ ä¹å›Šæ‹¬äº†å…¶å®ƒJDKè‡ªå¸¦å‘½ä»¤çš„æ‰€æœ‰åŠŸèƒ½ã€‚

- å†…å­˜ä¿¡æ¯

- çº¿ç¨‹ä¿¡æ¯

- Dumpå †ï¼ˆæœ¬åœ°è¿›ç¨‹ï¼‰

- Dumpçº¿ç¨‹ï¼ˆæœ¬åœ°è¿›ç¨‹ï¼‰

- æ‰“å¼€å †Dumpã€‚å †Dumpå¯ä»¥ç”¨jmapæ¥ç”Ÿæˆã€‚

- æ‰“å¼€çº¿ç¨‹Dump

- ç”Ÿæˆåº”ç”¨å¿«ç…§ï¼ˆåŒ…å«å†…å­˜ä¿¡æ¯ã€çº¿ç¨‹ä¿¡æ¯ç­‰ç­‰ï¼‰

- æ€§èƒ½åˆ†æã€‚CPUåˆ†æï¼ˆå„ä¸ªæ–¹æ³•è°ƒç”¨æ—¶é—´ï¼Œæ£€æŸ¥å“ªäº›æ–¹æ³•è€—æ—¶å¤šï¼‰ï¼Œå†…å­˜åˆ†æï¼ˆå„ç±»å¯¹è±¡å ç”¨çš„å†…å­˜ï¼Œæ£€æŸ¥

- å“ªäº›ç±»å ç”¨å†…å­˜å¤šï¼‰

  â€¦â€¦



#### 1.7.1 å¯åŠ¨

åœ¨jdkçš„å®‰è£…ç›®å½•çš„binç›®å½•ä¸‹ï¼Œæ‰¾åˆ°jvisualvm.exeï¼ŒåŒå‡»æ‰“å¼€å³å¯ã€‚

åŒå‡»inteliJ

**1.æŸ¥çœ‹æœ¬åœ°è¿›ç¨‹**

![](./assets/13.9.jpg)



**2.æŸ¥çœ‹CPUã€å†…å­˜ã€ç±»ã€çº¿ç¨‹è¿è¡Œä¿¡æ¯**

![](./assets/13.10.jpg)



**3.æŸ¥çœ‹çº¿ç¨‹è¯¦æƒ…**

![](./assets/13.11.jpg)

ä¹Ÿå¯ä»¥ç‚¹å‡»å³ä¸Šè§’DumpæŒ‰é’®ï¼Œå°†çº¿ç¨‹çš„ä¿¡æ¯å¯¼å‡ºï¼Œå…¶å®å°±æ˜¯æ‰§è¡Œçš„jstackå‘½ä»¤ã€‚

![](./assets/13.12.jpg)



**4.æŠ½æ ·å™¨**
æŠ½æ ·å™¨å¯ä»¥å¯¹CPUã€å†…å­˜åœ¨ä¸€æ®µæ—¶é—´å†…è¿›è¡ŒæŠ½æ ·ï¼Œä»¥ä¾›åˆ†æã€‚

![](./assets/13.13.jpg)



#### 1.7.2 ç›‘æ§è¿œç¨‹çš„jvm

VisualJVMä¸ä»…æ˜¯å¯ä»¥ç›‘æ§æœ¬åœ°jvmè¿›ç¨‹ï¼Œè¿˜å¯ä»¥ç›‘æ§è¿œç¨‹çš„jvmè¿›ç¨‹ï¼Œéœ€è¦å€ŸåŠ©äºJMXæŠ€æœ¯å®ç°ã€‚

**1.ç›‘æ§è¿œç¨‹çš„tomcat**
æƒ³è¦ç›‘æ§è¿œç¨‹çš„tomcatï¼Œå°±éœ€è¦åœ¨è¿œç¨‹çš„tomcatè¿›è¡Œå¯¹JMXé…ç½®ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

```shell
#åœ¨tomcatçš„binç›®å½•ä¸‹ï¼Œä¿®æ”¹catalina.shï¼Œæ·»åŠ å¦‚ä¸‹çš„å‚æ•°
JAVA_OPTS="-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9999 -
Dcom.sun.management.jmxremote.authenticate=false -
Dcom.sun.management.jmxremote.ssl=false"
#è¿™å‡ ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼š
#-Dcom.sun.management.jmxremote ï¼šå…è®¸ä½¿ç”¨JMXè¿œç¨‹ç®¡ç†
#-Dcom.sun.management.jmxremote.port=9999 ï¼šJMXè¿œç¨‹è¿æ¥ç«¯å£
#-Dcom.sun.management.jmxremote.authenticate=false ï¼šä¸è¿›è¡Œèº«ä»½è®¤è¯ï¼Œä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥è¿æ¥
#-Dcom.sun.management.jmxremote.ssl=false ï¼šä¸ä½¿ç”¨ssl
```



**2.ä½¿ç”¨VisualJVMè¿æ¥è¿œç¨‹tomcat**

æ·»åŠ è¿œç¨‹ä¸»æœºï¼š

![](./assets/13.14.jpg)

åœ¨ä¸€ä¸ªä¸»æœºä¸‹å¯èƒ½ä¼šæœ‰å¾ˆå¤šçš„jvméœ€è¦ç›‘æ§ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è¦åœ¨è¯¥ä¸»æœºä¸Šæ·»åŠ éœ€è¦ç›‘æ§çš„jvmï¼š

![](./assets/13.15.jpg)

![](./assets/13.16.jpg)

è¿æ¥æˆåŠŸã€‚ä½¿ç”¨æ–¹æ³•å’Œå‰é¢å°±ä¸€æ ·äº†ï¼Œå°±å¯ä»¥å’Œç›‘æ§æœ¬åœ°jvmè¿›ç¨‹ä¸€æ ·ï¼Œç›‘æ§è¿œç¨‹çš„tomcatè¿›ç¨‹ã€‚



#  :ice_cream:äºŒ

## 2.1 å¹´è½»ä»£å›æ”¶æ–¹å¼

1. åœ¨GCå¼€å§‹çš„æ—¶å€™ï¼Œå¯¹è±¡åªä¼šå­˜åœ¨äºEdenåŒºå’Œåä¸ºâ€œFromâ€çš„SurvivoråŒºï¼ŒSurvivoråŒºâ€œToâ€æ˜¯ç©ºçš„ã€‚
2. ç´§æ¥ç€è¿›è¡ŒGCï¼ŒEdenåŒºä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½ä¼šè¢«å¤åˆ¶åˆ°â€œToâ€ï¼Œè€Œåœ¨â€œFromâ€åŒºä¸­ï¼Œä»å­˜æ´»çš„å¯¹è±¡ä¼šæ ¹æ®ä»–ä»¬çš„
  å¹´é¾„å€¼æ¥å†³å®šå»å‘ã€‚å¹´é¾„è¾¾åˆ°ä¸€å®šå€¼(å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡-XX:MaxTenuringThresholdæ¥è®¾ç½®)çš„å¯¹è±¡ä¼šè¢«ç§»
  åŠ¨åˆ°å¹´è€ä»£ä¸­ï¼Œæ²¡æœ‰è¾¾åˆ°é˜ˆå€¼çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°â€œToâ€åŒºåŸŸã€‚
3. ç»è¿‡è¿™æ¬¡GCåï¼ŒEdenåŒºå’ŒFromåŒºå·²ç»è¢«æ¸…ç©ºã€‚è¿™ä¸ªæ—¶å€™ï¼Œâ€œFromâ€å’Œâ€œToâ€ä¼šäº¤æ¢ä»–ä»¬çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯æ–°
  çš„â€œToâ€å°±æ˜¯ä¸Šæ¬¡GCå‰çš„â€œFromâ€ï¼Œæ–°çš„â€œFromâ€å°±æ˜¯ä¸Šæ¬¡GCå‰çš„â€œToâ€ã€‚ä¸ç®¡æ€æ ·ï¼Œéƒ½ä¼šä¿è¯åä¸ºToçš„SurvivoråŒº
  åŸŸæ˜¯ç©ºçš„ã€‚
4. GCä¼šä¸€ç›´é‡å¤è¿™æ ·çš„è¿‡ç¨‹ï¼Œç›´åˆ°â€œToâ€åŒºè¢«å¡«æ»¡ï¼Œâ€œToâ€åŒºè¢«å¡«æ»¡ä¹‹åï¼Œä¼šå°†æ‰€æœ‰å¯¹è±¡ç§»åŠ¨åˆ°å¹´è€ä»£ä¸­ã€‚



## 2.2 åƒåœ¾å›æ”¶å™¨&å†…å­˜åˆ†é…

### 2.2.1 ä¸²è¡Œå›æ”¶å™¨

ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ï¼Œæ˜¯æŒ‡ä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œåƒåœ¾å›æ”¶æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Œå¹¶ä¸”javaåº”ç”¨ä¸­çš„æ‰€æœ‰çº¿ç¨‹
éƒ½è¦æš‚åœï¼Œç­‰å¾…åƒåœ¾å›æ”¶çš„å®Œæˆã€‚è¿™ç§ç°è±¡ç§°ä¹‹ä¸ºSTWã€‚



**1.è®¾ç½®åƒåœ¾å›æ”¶ä¸ºä¸²è¡Œæ”¶é›†å™¨**

åœ¨ç¨‹åºè¿è¡Œå‚æ•°ä¸­æ·»åŠ 2ä¸ªå‚æ•°ï¼Œå¦‚ä¸‹ï¼š

> -XX:+UseSerialGCï¼šæŒ‡å®šå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨
>
> -XX:+PrintGCDetailsï¼šæ‰“å°åƒåœ¾å›æ”¶çš„è¯¦ç»†ä¿¡æ¯



```shell
# ä¸ºäº†æµ‹è¯•GCï¼Œå°†å †çš„åˆå§‹å’Œæœ€å¤§å†…å­˜éƒ½è®¾ç½®ä¸º16M
-XX:+UseSerialGC -XX:+PrintGCDetails -Xms16m -Xmx16m
```

![](./assets/13.17.jpg)



å¯åŠ¨ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢ä¿¡æ¯ï¼š

```shell
[GC (Allocation Failure) [DefNew: 4416K->512K(4928K), 0.0046102 secs] 4416K-
>1973K(15872K), 0.0046533 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[Full GC (Allocation Failure) [Tenured: 10944K->3107K(10944K), 0.0085637 secs] 15871K-
>3107K(15872K), [Metaspace: 3496K->3496K(1056768K)], 0.0085974 secs] [Times: user=0.02
sys=0.00, real=0.01 secs]
```



>  GCæ—¥å¿—ä¿¡æ¯è§£è¯»

å¹´è½»ä»£çš„å†…å­˜GCå‰åçš„å¤§å°ï¼š

* DefNew

  è¡¨ç¤ºä½¿ç”¨çš„æ˜¯ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ã€‚

* 4416K->512K(4928K)

  è¡¨ç¤ºï¼Œå¹´è½»ä»£GCå‰ï¼Œå æœ‰4416Kå†…å­˜ï¼ŒGCåï¼Œå æœ‰512Kå†…å­˜ï¼Œæ€»å¤§å°4928K

* 0.0046102 secs

  è¡¨ç¤ºï¼ŒGCæ‰€ç”¨çš„æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚

* 4416K->1973K(15872K)

  è¡¨ç¤ºï¼ŒGCå‰ï¼Œå †å†…å­˜å æœ‰4416Kï¼ŒGCåï¼Œå æœ‰1973Kï¼Œæ€»å¤§å°ä¸º15872K

* Full GC

  è¡¨ç¤ºï¼Œå†…å­˜ç©ºé—´å…¨éƒ¨è¿›è¡ŒGC





### 2.2.2 å¹¶è¡Œå›æ”¶å™¨

å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨åœ¨ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨çš„åŸºç¡€ä¹‹ä¸Šåšäº†æ”¹è¿›ï¼Œå°†å•çº¿ç¨‹æ”¹ä¸ºäº†å¤šçº¿ç¨‹è¿›è¡Œåƒåœ¾å›æ”¶

#### 2.2.2.1 ParNewåƒåœ¾æ”¶é›†å™¨

ParNewåƒåœ¾æ”¶é›†å™¨æ˜¯å·¥ä½œåœ¨å¹´è½»ä»£ä¸Šçš„ï¼Œåªæ˜¯å°†ä¸²è¡Œçš„åƒåœ¾æ”¶é›†å™¨æ”¹ä¸ºäº†å¹¶è¡Œã€‚
é€šè¿‡-XX:+UseParNewGCå‚æ•°è®¾ç½®å¹´è½»ä»£ä½¿ç”¨ParNewå›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨çš„ä¾ç„¶æ˜¯ä¸²è¡Œæ”¶é›†å™¨ã€‚

![](./assets/13.18.jpg)



```shell
#å‚æ•°
-XX:+UseParNewGC -XX:+PrintGCDetails -Xms16m -Xmx16m
#æ‰“å°å‡ºçš„ä¿¡æ¯
[GC (Allocation Failure) [ParNew: 4416K->512K(4928K), 0.0032106 secs] 4416K-
>1988K(15872K), 0.0032697 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
```

> ç”±ä»¥ä¸Šä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œ ParNew: ä½¿ç”¨çš„æ˜¯ParNewæ”¶é›†å™¨ã€‚å…¶ä»–ä¿¡æ¯å’Œä¸²è¡Œæ”¶é›†å™¨ä¸€è‡´ã€‚



#### 2.2.2.2 Parallel Scavengeåƒåœ¾æ”¶é›†å™¨

ParallelGCæ”¶é›†å™¨å·¥ä½œæœºåˆ¶å’ŒParNewGCæ”¶é›†å™¨ä¸€æ ·ï¼Œåªæ˜¯åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šï¼Œæ–°å¢äº†ä¸¤ä¸ªå’Œç³»ç»Ÿååé‡ç›¸å…³çš„å‚æ•°ï¼Œ
ä½¿å¾—å…¶ä½¿ç”¨èµ·æ¥æ›´åŠ çš„çµæ´»å’Œé«˜æ•ˆã€‚

> ç›¸å…³å‚æ•°å¦‚ä¸‹

* -XX:+UseParallelGC

  å¹´è½»ä»£ä½¿ç”¨ParallelGCåƒåœ¾å›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ä¸²è¡Œå›æ”¶å™¨ã€‚

* -XX:+UseParallelOldGC

  å¹´è½»ä»£ä½¿ç”¨ParallelGCåƒåœ¾å›æ”¶å™¨ï¼Œè€å¹´ä»£ä½¿ç”¨ParallelOldGCåƒåœ¾å›æ”¶å™¨ã€‚

* -XX:MaxGCPauseMillis

  è®¾ç½®æœ€å¤§çš„åƒåœ¾æ”¶é›†æ—¶çš„åœé¡¿æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’

  éœ€è¦æ³¨æ„çš„æ—¶ï¼ŒParallelGCä¸ºäº†è¾¾åˆ°è®¾ç½®çš„åœé¡¿æ—¶é—´ï¼Œå¯èƒ½ä¼šè°ƒæ•´å †å¤§å°æˆ–å…¶ä»–çš„å‚æ•°ï¼Œå¦‚æœå †çš„å¤§å°
  è®¾ç½®çš„è¾ƒå°ï¼Œå°±ä¼šå¯¼è‡´GCå·¥ä½œå˜å¾—å¾ˆé¢‘ç¹ï¼Œåè€Œå¯èƒ½ä¼šå½±å“åˆ°æ€§èƒ½ã€‚
  è¯¥å‚æ•°ä½¿ç”¨éœ€è°¨æ…ã€‚

* -XX:GCTimeRatio

  è®¾ç½®åƒåœ¾å›æ”¶æ—¶é—´å ç¨‹åºè¿è¡Œæ—¶é—´çš„ç™¾åˆ†æ¯”ï¼Œå…¬å¼ä¸º1/(1+n)ã€‚
  å®ƒçš„å€¼ä¸º0~100ä¹‹é—´çš„æ•°å­—ï¼Œé»˜è®¤å€¼ä¸º99ï¼Œä¹Ÿå°±æ˜¯åƒåœ¾å›æ”¶æ—¶é—´ä¸èƒ½è¶…è¿‡1%

* -XX:UseAdaptiveSizePolicy

  è‡ªé€‚åº”GCæ¨¡å¼ï¼Œåƒåœ¾å›æ”¶å™¨å°†è‡ªåŠ¨è°ƒæ•´å¹´è½»ä»£ã€è€å¹´ä»£ç­‰å‚æ•°ï¼Œè¾¾åˆ°ååé‡ã€å †å¤§å°ã€åœé¡¿æ—¶é—´ä¹‹é—´çš„
  å¹³è¡¡ã€‚
  ä¸€èˆ¬ç”¨äºï¼Œæ‰‹åŠ¨è°ƒæ•´å‚æ•°æ¯”è¾ƒå›°éš¾çš„åœºæ™¯ï¼Œè®©æ”¶é›†å™¨è‡ªåŠ¨è¿›è¡Œè°ƒæ•´ã€‚

![](./assets/13.19.jpg)

```shell
#å‚æ•°
-XX:+UseParallelGC -XX:+UseParallelOldGC -XX:MaxGCPauseMillis=100 -XX:+PrintGCDetails -
Xms16m -Xmx16m
#æ‰“å°çš„ä¿¡æ¯
[GC (Allocation Failure) [PSYoungGen: 4096K->480K(4608K)] 4096K->1840K(15872K),
0.0034307 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
[Full GC (Ergonomics) [PSYoungGen: 505K->0K(4608K)] [ParOldGen: 10332K->10751K(11264K)]
10837K->10751K(15872K), [Metaspace: 3491K->3491K(1056768K)], 0.0793622 secs] [Times:
user=0.13 sys=0.00, real=0.08 secs]
```

> ç”±ä»¥ä¸Šä¿¡æ¯å¯ä»¥çœ‹å‡ºï¼Œå¹´è½»ä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨äº†ParallelGCåƒåœ¾å›æ”¶å™¨ã€‚



### 2.2.3 å¹¶å‘å›æ”¶å™¨

#### 2.2.3.1 CMS

é€šè¿‡å‚æ•°-XX:+UseConcMarkSweepGCè¿›è¡Œè®¾ç½®ã€‚

CMSåƒåœ¾å›æ”¶å™¨çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

![](./assets/13.20.jpg)

- åˆå§‹åŒ–æ ‡è®°(CMS-initial-mark) ,æ ‡è®°rootï¼Œä¼šå¯¼è‡´stwï¼›
- å¹¶å‘æ ‡è®°(CMS-concurrent-mark)ï¼Œä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼›
- é¢„æ¸…ç†ï¼ˆCMS-concurrent-precleanï¼‰ï¼Œä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼›
- é‡æ–°æ ‡è®°(CMS-remark) ï¼Œä¼šå¯¼è‡´stwï¼›
- å¹¶å‘æ¸…é™¤(CMS-concurrent-sweep)ï¼Œä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼›
- è°ƒæ•´å †å¤§å°ï¼Œè®¾ç½®CMSåœ¨æ¸…ç†ä¹‹åè¿›è¡Œå†…å­˜å‹ç¼©ï¼Œç›®çš„æ˜¯æ¸…ç†å†…å­˜ä¸­çš„ç¢ç‰‡ï¼›
- å¹¶å‘é‡ç½®çŠ¶æ€ç­‰å¾…ä¸‹æ¬¡CMSçš„è§¦å‘(CMS-concurrent-reset)ï¼Œä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼›

æµ‹è¯•ï¼š

```shell
#è®¾ç½®å¯åŠ¨å‚æ•°
-XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -Xms16m -Xmx16m
#è¿è¡Œæ—¥å¿—
[GC (Allocation Failure) [ParNew: 4926K->512K(4928K), 0.0041843 secs] 9424K-
>6736K(15872K), 0.0042168 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
#ç¬¬ä¸€æ­¥ï¼Œåˆå§‹æ ‡è®°
[GC (CMS Initial Mark) [1 CMS-initial-mark: 6224K(10944K)] 6824K(15872K), 0.0004209
secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
#ç¬¬äºŒæ­¥ï¼Œå¹¶å‘æ ‡è®°
[CMS-concurrent-mark-start]
[CMS-concurrent-mark: 0.002/0.002 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
#ç¬¬ä¸‰æ­¥ï¼Œé¢„å¤„ç†
[CMS-concurrent-preclean-start]
[CMS-concurrent-preclean: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
#ç¬¬å››æ­¥ï¼Œé‡æ–°æ ‡è®°
[GC (CMS Final Remark) [YG occupancy: 1657 K (4928 K)][Rescan (parallel) , 0.0005811
secs][weak refs processing, 0.0000136 secs][class unloading, 0.0003671 secs][scrub
symbol table, 0.0006813 secs][scrub string table, 0.0001216 secs][1 CMS-remark:
6224K(10944K)] 7881K(15872K), 0.0018324 secs] [Times: user=0.00 sys=0.00, real=0.00
secs]
#ç¬¬äº”æ­¥ï¼Œå¹¶å‘æ¸…ç†
[CMS-concurrent-sweep-start]
[CMS-concurrent-sweep: 0.004/0.004 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
#ç¬¬å…­æ­¥ï¼Œé‡ç½®
[CMS-concurrent-reset-start]
[CMS-concurrent-reset: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
```

> ç”±ä»¥ä¸Šæ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥çœ‹å‡ºCMSæ‰§è¡Œçš„è¿‡ç¨‹ã€‚



#### 2.2.3.2 G1

G1åƒåœ¾æ”¶é›†å™¨æ˜¯åœ¨jdk1.7ä¸­æ­£å¼ä½¿ç”¨çš„å…¨æ–°çš„åƒåœ¾æ”¶é›†å™¨ï¼Œoracleå®˜æ–¹è®¡åˆ’åœ¨jdk9ä¸­å°†G1å˜æˆé»˜è®¤çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä»¥æ›¿ä»£CMSã€‚
G1çš„è®¾è®¡åŸåˆ™å°±æ˜¯ç®€åŒ–JVMæ€§èƒ½è°ƒä¼˜ï¼Œå¼€å‘äººå‘˜åªéœ€è¦ç®€å•çš„ä¸‰æ­¥å³å¯å®Œæˆè°ƒä¼˜ï¼š

1. ç¬¬ä¸€æ­¥ï¼Œå¼€å¯G1åƒåœ¾æ”¶é›†å™¨
2. ç¬¬äºŒæ­¥ï¼Œè®¾ç½®å †çš„æœ€å¤§å†…å­˜
3. ç¬¬ä¸‰æ­¥ï¼Œè®¾ç½®æœ€å¤§çš„åœé¡¿æ—¶é—´

G1ä¸­æä¾›äº†ä¸‰ç§æ¨¡å¼åƒåœ¾å›æ”¶æ¨¡å¼ï¼ŒYoung GCã€Mixed GC å’Œ Full GCï¼Œåœ¨ä¸åŒçš„æ¡ä»¶ä¸‹è¢«è§¦å‘ã€‚

##### **2.2.3.2.1åŸç†**

G1åƒåœ¾æ”¶é›†å™¨ç›¸å¯¹æ¯”å…¶ä»–æ”¶é›†å™¨è€Œè¨€ï¼Œæœ€å¤§çš„åŒºåˆ«åœ¨äºå®ƒå–æ¶ˆäº†å¹´è½»ä»£ã€è€å¹´ä»£çš„ç‰©ç†åˆ’åˆ†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å°†å †
åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªåŒºåŸŸï¼ˆRegionï¼‰ï¼Œè¿™äº›åŒºåŸŸä¸­åŒ…å«äº†æœ‰é€»è¾‘ä¸Šçš„å¹´è½»ä»£ã€è€å¹´ä»£åŒºåŸŸã€‚
è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯ï¼Œæˆ‘ä»¬å†ä¹Ÿä¸ç”¨å•ç‹¬çš„ç©ºé—´å¯¹æ¯ä¸ªä»£è¿›è¡Œè®¾ç½®äº†ï¼Œä¸ç”¨æ‹…å¿ƒæ¯ä¸ªä»£å†…å­˜æ˜¯å¦è¶³å¤Ÿã€‚

![](./assets/13.21.jpg)

åœ¨G1åˆ’åˆ†çš„åŒºåŸŸä¸­ï¼Œå¹´è½»ä»£çš„åƒåœ¾æ”¶é›†ä¾ç„¶é‡‡ç”¨æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹çš„æ–¹å¼ï¼Œå°†å­˜æ´»å¯¹è±¡æ‹·è´åˆ°è€å¹´ä»£æˆ–è€…Survivor
ç©ºé—´ï¼ŒG1æ”¶é›†å™¨é€šè¿‡å°†å¯¹è±¡ä»ä¸€ä¸ªåŒºåŸŸå¤åˆ¶åˆ°å¦å¤–ä¸€ä¸ªåŒºåŸŸï¼Œå®Œæˆäº†æ¸…ç†å·¥ä½œã€‚
è¿™å°±æ„å‘³ç€ï¼Œåœ¨æ­£å¸¸çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼ŒG1å®Œæˆäº†å †çš„å‹ç¼©ï¼ˆè‡³å°‘æ˜¯éƒ¨åˆ†å †çš„å‹ç¼©ï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±ä¸ä¼šæœ‰cmså†…å­˜ç¢ç‰‡é—®
é¢˜çš„å­˜åœ¨äº†ã€‚



åœ¨G1ä¸­ï¼Œæœ‰ä¸€ç§ç‰¹æ®Šçš„åŒºåŸŸï¼Œå«HumongousåŒºåŸŸã€‚
å¦‚æœä¸€ä¸ªå¯¹è±¡å ç”¨çš„ç©ºé—´è¶…è¿‡äº†åˆ†åŒºå®¹é‡50%ä»¥ä¸Šï¼ŒG1æ”¶é›†å™¨å°±è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå·¨å‹å¯¹è±¡ã€‚
è¿™äº›å·¨å‹å¯¹è±¡ï¼Œé»˜è®¤ç›´æ¥ä¼šè¢«åˆ†é…åœ¨è€å¹´ä»£ï¼Œä½†æ˜¯å¦‚æœå®ƒæ˜¯ä¸€ä¸ªçŸ­æœŸå­˜åœ¨çš„å·¨å‹å¯¹è±¡ï¼Œå°±ä¼šå¯¹åƒåœ¾æ”¶é›†å™¨é€ 
æˆè´Ÿé¢å½±å“ã€‚
ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒG1åˆ’åˆ†äº†ä¸€ä¸ªHumongousåŒºï¼Œå®ƒç”¨æ¥ä¸“é—¨å­˜æ”¾å·¨å‹å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªHåŒºè£…ä¸ä¸‹ä¸€ä¸ªå·¨å‹
å¯¹è±¡ï¼Œé‚£ä¹ˆG1ä¼šå¯»æ‰¾è¿ç»­çš„Håˆ†åŒºæ¥å­˜å‚¨ã€‚ä¸ºäº†èƒ½æ‰¾åˆ°è¿ç»­çš„HåŒºï¼Œæœ‰æ—¶å€™ä¸å¾—ä¸å¯åŠ¨Full GCã€‚



##### **2.2.3.2.2 Young GC**

Young GCä¸»è¦æ˜¯å¯¹EdenåŒºè¿›è¡ŒGCï¼Œå®ƒåœ¨Edenç©ºé—´è€—å°½æ—¶ä¼šè¢«è§¦å‘ã€‚

- Edenç©ºé—´çš„æ•°æ®ç§»åŠ¨åˆ°Survivorç©ºé—´ä¸­ï¼Œå¦‚æœSurvivorç©ºé—´ä¸å¤Ÿï¼ŒEdenç©ºé—´çš„éƒ¨åˆ†æ•°æ®ä¼šç›´æ¥æ™‹å‡åˆ°å¹´è€ä»£
- ç©ºé—´ã€‚
- SurvivoråŒºçš„æ•°æ®ç§»åŠ¨åˆ°æ–°çš„SurvivoråŒºä¸­ï¼Œä¹Ÿæœ‰éƒ¨åˆ†æ•°æ®æ™‹å‡åˆ°è€å¹´ä»£ç©ºé—´ä¸­ã€‚
- æœ€ç»ˆEdenç©ºé—´çš„æ•°æ®ä¸ºç©ºï¼ŒGCåœæ­¢å·¥ä½œï¼Œåº”ç”¨çº¿ç¨‹ç»§ç»­æ‰§è¡Œã€‚

![](./assets/13.22.jpg)

![](./assets/13.23.jpg)



> Remembered Setï¼ˆå·²è®°å¿†é›†åˆï¼‰

 æ–°ç”Ÿä»£ GCï¼ˆå‘ç”Ÿå¾—éå¸¸é¢‘ç¹ï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ  GCè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆæšä¸¾æ ¹èŠ‚ç‚¹ã€‚æ ¹èŠ‚ç‚¹æœ‰å¯èƒ½åœ¨æ–°ç”Ÿä»£ä¸­ï¼Œä¹Ÿæœ‰å¯èƒ½åœ¨è€å¹´ä»£ä¸­ã€‚è¿™é‡Œç”±äºæˆ‘ä»¬åªæƒ³æ”¶é›†æ–°ç”Ÿä»£ï¼ˆæ¢å¥è¯è¯´ï¼Œä¸æƒ³æ”¶é›†è€å¹´ä»£ï¼‰ï¼Œæ‰€ä»¥æ²¡æœ‰å¿…è¦å¯¹ä½äºè€å¹´ä»£çš„ GC Roots åšå…¨é¢çš„å¯è¾¾æ€§åˆ†æã€‚ä½†é—®é¢˜æ˜¯ï¼Œç¡®å®å¯èƒ½å­˜åœ¨ä½äºè€å¹´ä»£çš„æŸä¸ª GC  Rootï¼Œå®ƒå¼•ç”¨äº†æ–°ç”Ÿä»£çš„æŸä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä½ æ˜¯ä¸èƒ½æ¸…é™¤çš„ã€‚æ‰€ä»¥â€œè€å¹´ä»£å¯¹è±¡å¼•ç”¨æ–°ç”Ÿä»£å¯¹è±¡â€è¿™ç§å…³ç³»ï¼Œä¼šåœ¨å¼•ç”¨å…³ç³»å‘ç”Ÿæ—¶ï¼Œåœ¨æ–°ç”Ÿä»£è¾¹ä¸Šä¸“é—¨å¼€è¾Ÿä¸€å—ç©ºé—´è®°å½•ä¸‹æ¥ï¼Œè¿™å°±æ˜¯RememberedSetï¼Œ 

è€ŒG1 æ”¶é›†å™¨ä½¿ç”¨çš„æ˜¯åŒ–æ•´ä¸ºé›¶çš„æ€æƒ³ï¼ŒæŠŠä¸€å—å¤§çš„å†…å­˜åˆ’åˆ†æˆå¾ˆå¤šä¸ªåŸŸï¼ˆ Region ï¼‰ã€‚ä½†é—®é¢˜æ˜¯ï¼Œéš¾å…æœ‰ä¸€ä¸ª Region ä¸­çš„å¯¹è±¡å¼•ç”¨å¦ä¸€ä¸ª  Region ä¸­å¯¹è±¡çš„æƒ…å†µã€‚ä¸ºäº†è¾¾åˆ°å¯ä»¥ä»¥ Region ä¸ºå•ä½è¿›è¡Œåƒåœ¾å›æ”¶çš„ç›®çš„ï¼Œ G1 æ”¶é›†å™¨ä¹Ÿä½¿ç”¨äº† RememberedSet  è¿™ç§æŠ€æœ¯ã€‚G1ä¸­æ¯ä¸ªRegionéƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„RememberedSet ï¼Œåœ¨å„ä¸ª Region ä¸Šè®°å½•è‡ªå®¶çš„å¯¹è±¡è¢«å¤–é¢å¯¹è±¡å¼•ç”¨çš„æƒ…å†µã€‚ 

![](./assets/13.24.jpg)

æ¯ä¸ªRegioné»˜è®¤æŒ‰ç…§512Kbåˆ’åˆ†æˆå¤šä¸ªCardï¼Œæ‰€ä»¥RSetéœ€è¦è®°å½•çš„ä¸œè¥¿åº”è¯¥æ˜¯ xx Regionçš„ xx Cardã€‚

**å¦‚å›¾ï¼ŒRegion1å’ŒRegion3å¼•ç”¨äº†Region2ï¼Œè¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œä¼šå‘ç°Region1æœ‰æ ¹å¯¹è±¡Aå¼•ç”¨äº†Region2ä¸­çš„Bï¼Œæ‰€ä»¥Region2ä¸­çš„Bå¯¹è±¡ä¸å›æ”¶ã€‚é¿å…æ•´ä¸ªå †è¿›è¡Œæ‰«æ**

 



##### **2.2.3.2.3 Mixed GC**

å½“è¶Šæ¥è¶Šå¤šçš„å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£old regionæ—¶ï¼Œä¸ºäº†é¿å…å †å†…å­˜è¢«è€—å°½ï¼Œè™šæ‹Ÿæœºä¼šè§¦å‘ä¸€ä¸ªæ··åˆçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå³
Mixed GCï¼Œè¯¥ç®—æ³•å¹¶ä¸æ˜¯ä¸€ä¸ªOld GCï¼Œé™¤äº†å›æ”¶æ•´ä¸ªYoung Regionï¼Œè¿˜ä¼šå›æ”¶ä¸€éƒ¨åˆ†çš„Old Regionï¼Œè¿™é‡Œéœ€è¦æ³¨
æ„ï¼šæ˜¯ä¸€éƒ¨åˆ†è€å¹´ä»£ï¼Œè€Œä¸æ˜¯å…¨éƒ¨è€å¹´ä»£ï¼Œå¯ä»¥é€‰æ‹©å“ªäº›old regionè¿›è¡Œæ”¶é›†ï¼Œä»è€Œå¯ä»¥å¯¹åƒåœ¾å›æ”¶çš„è€—æ—¶æ—¶é—´è¿›
è¡Œæ§åˆ¶ã€‚ä¹Ÿè¦æ³¨æ„çš„æ˜¯Mixed GC å¹¶ä¸æ˜¯ Full GCã€‚
MixedGCä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿ ç”±å‚æ•° -XX:InitiatingHeapOccupancyPercent=n å†³å®šã€‚é»˜è®¤ï¼š45%ï¼Œè¯¥å‚æ•°çš„æ„æ€æ˜¯ï¼š
å½“è€å¹´ä»£å¤§å°å æ•´ä¸ªå †å¤§å°ç™¾åˆ†æ¯”è¾¾åˆ°è¯¥é˜€å€¼æ—¶è§¦å‘ã€‚

å®ƒçš„GCæ­¥éª¤åˆ†2æ­¥ï¼š

1. å…¨å±€å¹¶å‘æ ‡è®°ï¼ˆglobal concurrent markingï¼‰
2. æ‹·è´å­˜æ´»å¯¹è±¡ï¼ˆevacuationï¼‰



**1.å…¨å±€å¹¶å‘æ ‡è®°**
å…¨å±€å¹¶å‘æ ‡è®°ï¼Œæ‰§è¡Œè¿‡ç¨‹åˆ†ä¸ºäº”ä¸ªæ­¥éª¤ï¼š

* åˆå§‹æ ‡è®°ï¼ˆinitial markï¼ŒSTWï¼‰

  æ ‡è®°ä»æ ¹èŠ‚ç‚¹ç›´æ¥å¯è¾¾çš„å¯¹è±¡ï¼Œè¿™ä¸ªé˜¶æ®µä¼šæ‰§è¡Œä¸€æ¬¡å¹´è½»ä»£GCï¼Œä¼šäº§ç”Ÿå…¨å±€åœé¡¿ã€‚

* æ ¹åŒºåŸŸæ‰«æï¼ˆroot region scanï¼‰

  * G1 GC åœ¨åˆå§‹æ ‡è®°çš„å­˜æ´»åŒºæ‰«æå¯¹è€å¹´ä»£çš„å¼•ç”¨ï¼Œå¹¶æ ‡è®°è¢«å¼•ç”¨çš„å¯¹è±¡ã€‚
  * è¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºï¼ˆé STWï¼‰åŒæ—¶è¿è¡Œï¼Œå¹¶ä¸”åªæœ‰å®Œæˆè¯¥é˜¶æ®µåï¼Œæ‰èƒ½å¼€å§‹ä¸‹ä¸€æ¬¡ STW å¹´è½»ä»£åƒåœ¾å›

  æ”¶ã€‚

* å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰

  G1 GC åœ¨æ•´ä¸ªå †ä¸­æŸ¥æ‰¾å¯è®¿é—®çš„ï¼ˆå­˜æ´»çš„ï¼‰å¯¹è±¡ã€‚è¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºåŒæ—¶è¿è¡Œï¼Œå¯ä»¥è¢« STW å¹´è½»ä»£åƒ
  åœ¾å›æ”¶ä¸­æ–­ã€‚

* é‡æ–°æ ‡è®°ï¼ˆRemarkï¼ŒSTWï¼‰

  è¯¥é˜¶æ®µæ˜¯ STW å›æ”¶ï¼Œå› ä¸ºç¨‹åºåœ¨è¿è¡Œï¼Œé’ˆå¯¹ä¸Šä¸€æ¬¡çš„æ ‡è®°è¿›è¡Œä¿®æ­£ã€‚

* æ¸…é™¤åƒåœ¾ï¼ˆCleanupï¼ŒSTWï¼‰

  æ¸…ç‚¹å’Œé‡ç½®æ ‡è®°çŠ¶æ€ï¼Œè¯¥é˜¶æ®µä¼šSTWï¼Œè¿™ä¸ªé˜¶æ®µå¹¶ä¸ä¼šå®é™…ä¸Šå»åšåƒåœ¾çš„æ”¶é›†ï¼Œç­‰å¾…evacuationé˜¶æ®µæ¥
  å›æ”¶ã€‚



**2.æ‹·è´å­˜æ´»å¯¹è±¡**
Evacuationé˜¶æ®µæ˜¯å…¨æš‚åœçš„ã€‚è¯¥é˜¶æ®µæŠŠä¸€éƒ¨åˆ†Regioné‡Œçš„æ´»å¯¹è±¡æ‹·è´åˆ°å¦ä¸€éƒ¨åˆ†Regionä¸­ï¼Œä»è€Œå®ç°åƒåœ¾çš„å›æ”¶
æ¸…ç†ã€‚





##### 2.2.3.2.4 G1æ”¶é›†å™¨ç›¸å…³å‚æ•°

* -XX:+UseG1GC

  ä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨

* -XX:MaxGCPauseMillis

  è®¾ç½®æœŸæœ›è¾¾åˆ°çš„æœ€å¤§GCåœé¡¿æ—¶é—´æŒ‡æ ‡ï¼ˆJVMä¼šå°½åŠ›å®ç°ï¼Œä½†ä¸ä¿è¯è¾¾åˆ°ï¼‰ï¼Œé»˜è®¤å€¼æ˜¯ 200 æ¯«ç§’ã€‚

* -XX:G1HeapRegionSize=n

  è®¾ç½®çš„ G1 åŒºåŸŸçš„å¤§å°ã€‚å€¼æ˜¯ 2 çš„å¹‚ï¼ŒèŒƒå›´æ˜¯ 1 MB åˆ° 32 MB ä¹‹é—´ã€‚ç›®æ ‡æ˜¯æ ¹æ®æœ€å°çš„ Java å †å¤§å°åˆ’
  åˆ†å‡ºçº¦ 2048 ä¸ªåŒºåŸŸã€‚
  é»˜è®¤æ˜¯å †å†…å­˜çš„1/2000ã€‚

* -XX:ParallelGCThreads=n

  è®¾ç½® STW å·¥ä½œçº¿ç¨‹æ•°çš„å€¼ã€‚å°† n çš„å€¼è®¾ç½®ä¸ºé€»è¾‘å¤„ç†å™¨çš„æ•°é‡ã€‚n çš„å€¼ä¸é€»è¾‘å¤„ç†å™¨çš„æ•°é‡ç›¸åŒï¼Œæœ€å¤š
  ä¸º 8ã€‚

* -XX:ConcGCThreads=n

  è®¾ç½®å¹¶è¡Œæ ‡è®°çš„çº¿ç¨‹æ•°ã€‚å°† n è®¾ç½®ä¸ºå¹¶è¡Œåƒåœ¾å›æ”¶çº¿ç¨‹æ•° (ParallelGCThreads) çš„ 1/4 å·¦å³ã€‚

* -XX:InitiatingHeapOccupancyPercent=n

  MIXED GCçš„è§¦å‘å€¼ï¼Œé»˜è®¤è€å¹´ä»£å ç”¨ç‡æ˜¯æ•´ä¸ª Java å †çš„ 45%ã€‚

 

> æµ‹è¯•

```shell
-XX:+UseG1GC -XX:MaxGCPauseMillis=100 -XX:+PrintGCDetails -Xmx256m
#æ—¥å¿—
[GC pause (G1 Evacuation Pause) (young), 0.0044882 secs]
[Parallel Time: 3.7 ms, GC Workers: 3]
[GC Worker Start (ms): Min: 14763.7, Avg: 14763.8, Max: 14763.8, Diff: 0.1]
#æ‰«ææ ¹èŠ‚ç‚¹
[Ext Root Scanning (ms): Min: 0.2, Avg: 0.3, Max: 0.3, Diff: 0.1, Sum: 0.8]
#æ›´æ–°RSåŒºåŸŸæ‰€æ¶ˆè€—çš„æ—¶é—´
[Update RS (ms): Min: 1.8, Avg: 1.9, Max: 1.9, Diff: 0.2, Sum: 5.6]
[Processed Buffers: Min: 1, Avg: 1.7, Max: 3, Diff: 2, Sum: 5]
[Scan RS (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
[Code Root Scanning (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
#å¯¹è±¡æ‹·è´
[Object Copy (ms): Min: 1.1, Avg: 1.2, Max: 1.3, Diff: 0.2, Sum: 3.6]
[Termination (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2, Sum: 0.2]
[Termination Attempts: Min: 1, Avg: 1.0, Max: 1, Diff: 0, Sum: 3]
[GC Worker Other (ms): Min: 0.0, Avg: 0.0, Max: 0.0, Diff: 0.0, Sum: 0.0]
[GC Worker Total (ms): Min: 3.4, Avg: 3.4, Max: 3.5, Diff: 0.1, Sum: 10.3]
[GC Worker End (ms): Min: 14767.2, Avg: 14767.2, Max: 14767.3, Diff: 0.1]
[Code Root Fixup: 0.0 ms]
[Code Root Purge: 0.0 ms]
[Clear CT: 0.0 ms] #æ¸…ç©ºCardTable
[Other: 0.7 ms]
[Choose CSet: 0.0 ms] #é€‰å–CSet
[Ref Proc: 0.5 ms] #å¼±å¼•ç”¨ã€è½¯å¼•ç”¨çš„å¤„ç†è€—æ—¶
[Ref Enq: 0.0 ms] #å¼±å¼•ç”¨ã€è½¯å¼•ç”¨çš„å…¥é˜Ÿè€—æ—¶
[Redirty Cards: 0.0 ms]
[Humongous Register: 0.0 ms] #å¤§å¯¹è±¡åŒºåŸŸæ³¨å†Œè€—æ—¶
[Humongous Reclaim: 0.0 ms] #å¤§å¯¹è±¡åŒºåŸŸå›æ”¶è€—æ—¶
[Free CSet: 0.0 ms]
[Eden: 7168.0K(7168.0K)->0.0B(13.0M) Survivors: 2048.0K->2048.0K Heap:
55.5M(192.0M)->48.5M(192.0M)] #å¹´è½»ä»£çš„å¤§å°ç»Ÿè®¡
[Times: user=0.00 sys=0.00, real=0.00 secs]
```

 

##### 2.2.3.2.5 å¯¹äºG1åƒåœ¾æ”¶é›†å™¨ä¼˜åŒ–å»ºè®®

* å¹´è½»ä»£å¤§å°

  * é¿å…ä½¿ç”¨ -Xmn é€‰é¡¹æˆ– -XX:NewRatio ç­‰å…¶ä»–ç›¸å…³é€‰é¡¹æ˜¾å¼è®¾ç½®å¹´è½»ä»£å¤§å°ã€‚
  * å›ºå®šå¹´è½»ä»£çš„å¤§å°ä¼šè¦†ç›–æš‚åœæ—¶é—´ç›®æ ‡ã€‚

* æš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªè¿‡ä¸¥è‹›

  * G1 GC çš„ååé‡ç›®æ ‡æ˜¯ 90% çš„åº”ç”¨ç¨‹åºæ—¶é—´å’Œ 10%çš„åƒåœ¾å›æ”¶æ—¶é—´ã€‚
  * è¯„ä¼° G1 GC çš„ååé‡æ—¶ï¼Œæš‚åœæ—¶é—´ç›®æ ‡ä¸è¦å¤ªä¸¥è‹›ã€‚ç›®æ ‡å¤ªè¿‡ä¸¥è‹›è¡¨ç¤ºæ‚¨æ„¿æ„æ‰¿å—æ›´å¤šçš„åƒåœ¾å›æ”¶å¼€

  é”€ï¼Œè€Œè¿™ä¼šç›´æ¥å½±å“åˆ°ååé‡ã€‚



## 2.3 å¯è§†åŒ–GCæ—¥å¿—åˆ†æå·¥å…·

### 2.3.1 æ—¥å¿—è®¾ç½®å‚æ•°

å‰é¢é€šè¿‡-XX:+PrintGCDetailså¯ä»¥å¯¹GCæ—¥å¿—è¿›è¡Œæ‰“å°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æ§åˆ¶å°æŸ¥çœ‹ï¼Œè¿™æ ·è™½ç„¶å¯ä»¥æŸ¥çœ‹GCçš„ä¿¡æ¯ï¼Œ
ä½†æ˜¯å¹¶ä¸ç›´è§‚ï¼Œå¯ä»¥å€ŸåŠ©äºç¬¬ä¸‰æ–¹çš„GCæ—¥å¿—åˆ†æå·¥å…·è¿›è¡ŒæŸ¥çœ‹ã€‚

åœ¨æ—¥å¿—æ‰“å°è¾“å‡ºæ¶‰åŠåˆ°çš„å‚æ•°å¦‚ä¸‹ï¼š

```shell
-XX:+PrintGC è¾“å‡ºGCæ—¥å¿—
-XX:+PrintGCDetails è¾“å‡ºGCçš„è¯¦ç»†æ—¥å¿—
-XX:+PrintGCTimeStamps è¾“å‡ºGCçš„æ—¶é—´æˆ³ï¼ˆä»¥åŸºå‡†æ—¶é—´çš„å½¢å¼ï¼‰
-XX:+PrintGCDateStamps è¾“å‡ºGCçš„æ—¶é—´æˆ³ï¼ˆä»¥æ—¥æœŸçš„å½¢å¼ï¼Œå¦‚ 2013-05-04T21:53:59.234+0800ï¼‰
-XX:+PrintHeapAtGC åœ¨è¿›è¡ŒGCçš„å‰åæ‰“å°å‡ºå †çš„ä¿¡æ¯
-Xloggc:../logs/gc.log æ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„
```

æµ‹è¯•ï¼š

```shell
-XX:+UseG1GC -XX:MaxGCPauseMillis=100 -Xmx256m -XX:+PrintGCDetails -
XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+PrintHeapAtGC -
Xloggc:F://test//gc.log
```

è¿è¡Œåå°±å¯ä»¥åœ¨Fç›˜ä¸‹ç”Ÿæˆgc.logæ–‡ä»¶ã€‚



### 2.3.2 GC Easy å¯è§†åŒ–å·¥å…·

GC Easyæ˜¯ä¸€æ¬¾åœ¨çº¿çš„å¯è§†åŒ–å·¥å…·ï¼Œæ˜“ç”¨ã€åŠŸèƒ½å¼ºå¤§ï¼Œç½‘ç«™ï¼š
http://gceasy.io/

![](./assets/13.25.jpg)



![](./assets/13.26.jpg)



![](./assets/13.27.jpg)

![](./assets/13.28.jpg)





# :tada:  ä¸‰

## 1 Tomcat8ä¼˜åŒ–

tomcatæœåŠ¡å™¨åœ¨JavaEEé¡¹ç›®ä¸­ä½¿ç”¨ç‡éå¸¸é«˜ï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒå¯¹tomcatçš„ä¼˜åŒ–ä¹Ÿå˜å¾—éå¸¸é‡è¦äº†ã€‚
å¯¹äºtomcatçš„ä¼˜åŒ–ï¼Œä¸»è¦æ˜¯ä»2ä¸ªæ–¹é¢å…¥æ‰‹ï¼Œä¸€æ˜¯ï¼Œtomcatè‡ªèº«çš„é…ç½®ï¼Œå¦ä¸€ä¸ªæ˜¯tomcatæ‰€è¿è¡Œçš„jvmè™šæ‹Ÿæœºçš„è°ƒä¼˜ã€‚
ä¸‹é¢æˆ‘ä»¬å°†ä»è¿™2ä¸ªæ–¹é¢è¿›è¡Œè®²è§£ã€‚

### 1.1 Tomcaté…ç½®ä¼˜åŒ–

:cloud:todo...day3-ç¬¬äºŒèŠ‚











## 2 JVMå­—èŠ‚ç 